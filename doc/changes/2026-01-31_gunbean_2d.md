# 枪豆人 2D 化改造

**日期**: 2026-01-31
**作者**: Claude Opus 4.5

## 改动概述

将枪豆人游戏从 3D (Three.js) 改为 2D (Canvas)，场景改为海洋背景，玩家改为卡通小船。

## 需求

1. 改为 2D 游戏，不使用 3D
2. 所有人物在一个队伍（合作模式）
3. 房间最大 4 人
4. 背景是一片大海
5. 玩家坐在船上
6. 通过鼠标控制开火方向
7. 通过开火的反重力移动

## 修改文件清单

| 文件 | 改动类型 | 说明 |
|------|----------|------|
| `shared/GameTypes.js` | 修改 | 更新游戏描述和图标 |
| `client/games/gunbean/GunBeanScene.js` | 重写 | Three.js 3D → Canvas 2D |
| `server/games/gunbean/GunBeanHandler.js` | 修改 | z坐标 → y坐标，圆形场地 → 矩形场地 |
| `client/games/gunbean/GunBeanGame.js` | 修改 | 适配 2D 场景 API |
| `client/games/gunbean/GunBeanInput.js` | 修改 | 适配 2D 坐标系统 |
| `client/games/gunbean/GunBeanUI.js` | 小改 | 更新操作提示 |

## 核心改动详情

### 1. 场景渲染 (GunBeanScene.js)

**原来**：使用 Three.js 创建 3D 场景
- 透视摄像机
- 3D 球形玩家模型
- 圆形平台
- 3D 海洋平面

**改为**：使用 HTML5 Canvas 2D 渲染
- 游戏坐标转屏幕坐标
- 卡通风格小船（俯视图）
- 矩形场地
- 渐变海洋背景 + 波浪动画

### 2. 坐标系统

**原来**：3D 坐标 (x, y, z)
- x: 水平
- y: 高度
- z: 深度

**改为**：2D 坐标 (x, y)
- x: 水平
- y: 垂直

### 3. 场地形状

**原来**：圆形平台（半径 12）
- 玩家掉出圆形边界死亡

**改为**：矩形场地（800 × 600）
- 玩家掉出矩形边界死亡

### 4. 物理参数调整

| 参数 | 原值 | 新值 | 说明 |
|------|------|------|------|
| ARENA_RADIUS | 12 | - | 删除 |
| ARENA_WIDTH | - | 800 | 新增 |
| ARENA_HEIGHT | - | 600 | 新增 |
| BULLET_SPEED | 20 | 400 | 像素/秒 |
| RECOIL_FORCE | 3 | 150 | 像素/秒 |
| REVIVE_DISTANCE | 1.5 | 60 | 像素 |
| PLAYER_RADIUS | 0.4 | 20 | 像素 |
| ENEMY_RADIUS | 0.5 | 20 | 像素 |
| ENEMY_SPEED | 2 | 80 | 像素/秒 |

### 5. 玩家出生点

**原来**：圆形分布
```javascript
const angle = (index / total) * Math.PI * 2;
const radius = CONFIG.ARENA_RADIUS * 0.6;
return { x: Math.cos(angle) * radius, z: Math.sin(angle) * radius };
```

**改为**：四角分布
```javascript
const positions = [
    { x: -halfW, y: -halfH },  // 左上
    { x: halfW, y: -halfH },   // 右上
    { x: -halfW, y: halfH },   // 左下
    { x: halfW, y: halfH }     // 右下
];
return positions[index % positions.length];
```

### 6. 视觉效果

**卡通小船设计**：
- 椭圆形船身
- 三角形船头
- 棕色船舱
- 圆形炮台 + 炮管
- 玩家颜色区分

**敌人**：保留红色方块怪，带黄色眼睛

**子弹**：黄色圆形 + 橙色拖尾

**爆炸效果**：红/橙色粒子

## 代码对比

### 射击事件数据

**原来**：
```javascript
network.emit(GUNBEAN_EVENTS.SHOOT, { dirX, dirZ });
```

**改为**：
```javascript
network.emit(GUNBEAN_EVENTS.SHOOT, { dirX, dirY });
```

### 玩家位置更新

**原来**：
```javascript
this.scene.updatePlayerPosition(p.id, p.x, p.z, p.vx, p.vz);
```

**改为**：
```javascript
this.scene.updatePlayerPosition(p.id, p.x, p.y, p.vx, p.vy);
```

## 测试要点

1. 玩家能正确显示为卡通小船
2. 鼠标瞄准方向正确（船头朝向鼠标）
3. 射击产生后坐力，推动小船反向移动
4. 子弹方向正确
5. 掉出矩形边界死亡
6. 敌人正确追踪玩家
7. 复活功能正常
8. 多人同步正常

## 回退方案

如需回退到 3D 版本，可从 git 历史恢复以下文件：
- `client/games/gunbean/GunBeanScene.js`
- `client/games/gunbean/GunBeanGame.js`
- `client/games/gunbean/GunBeanInput.js`
- `client/games/gunbean/GunBeanUI.js`
- `server/games/gunbean/GunBeanHandler.js`
- `shared/GameTypes.js`
