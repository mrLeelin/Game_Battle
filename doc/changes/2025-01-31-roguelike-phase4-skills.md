# 枪豆人 Roguelike 第四阶段技能实现

## 日期
2025-01-31

## 概述
实现 Roguelike 技能系统第四阶段的4个高难度技能：激光炮、黑洞、幽灵船、复仇。同时更新 Roguelike.md 文档。

## 修改文件

### 1. server/games/gunbean/GunBeanSkillData.js

**新增技能配置**（4个）：

| ID | 名称 | 图标 | 稀有度 | 描述 | 每级效果 | 最大等级 |
|----|------|------|--------|------|----------|----------|
| laserGun | 激光炮 | 🔦 | Epic | 每隔一段时间发射激光，有巨大后坐力 | -5秒冷却时间 | 3 |
| blackHole | 黑洞 | 🕳️ | Epic | 击杀敌人生成黑洞吸引周围敌人 | +20%吸引范围 | 2 |
| ghostShip | 幽灵船 | 👻 | Epic | 受伤后短暂无敌 | +0.3秒无敌时间 | 3 |
| revenge | 复仇 | 😈 | Epic | 受伤时对周围敌人造成伤害 | +50%反伤范围 | 3 |

### 2. server/games/gunbean/GunBeanHandler.js

**修改内容**：

#### 2.1 游戏状态新增字段
- `blackHoles`: 黑洞 Map
- `blackHoleIdCounter`: 黑洞ID计数器
- `lastLaserTime`: 上次激光炮时间

#### 2.2 船只数据新增字段
- `invincibleUntil`: 无敌状态结束时间

#### 2.3 enemyHitBoat 方法
- 新增幽灵船效果：无敌状态检查和触发
- 新增复仇效果：受伤时对周围敌人造成伤害

#### 2.4 killEnemy 方法
- 新增黑洞效果：击杀敌人时生成黑洞

#### 2.5 updatePhysics 方法
- 新增黑洞吸引效果：吸引范围内的敌人
- 新增激光炮效果：定时发射穿透激光

### 3. shared/Events.js

**新增事件**：
- `BLACK_HOLE_SPAWNED`: 黑洞生成
- `BLACK_HOLE_EXPIRED`: 黑洞消失
- `LASER_FIRED`: 激光炮发射
- `GHOST_SHIP`: 幽灵船无敌效果
- `REVENGE`: 复仇效果

### 4. doc/game/qiangdouren/Roguelike.md

**更新内容**：
- 更新已实现技能列表（Common 13个、Rare 15个、Epic 9个）
- 更新实现优先级（第一至第四阶段标记为已完成）
- 更新更新日志

## 技能机制说明

### 激光炮 🔦
- 基础冷却20秒，每级减少5秒（最低5秒）
- 自动瞄准最近的敌人
- 激光穿透所有敌人，造成 5 + 等级×2 点伤害
- 激光长度600像素，宽度30像素
- 发射时产生巨大后坐力（300）

### 黑洞 🕳️
- 击杀敌人时在敌人位置生成黑洞
- 基础吸引范围100像素，每级增加20%
- 黑洞存在3秒
- 吸引速度150像素/秒
- 不会对敌人造成伤害，只是吸引

### 幽灵船 👻
- 船只受伤后触发无敌状态
- 无敌时间 = 等级 × 0.3秒
- 无敌期间敌人碰撞不造成伤害
- 敌人仍然会消失

### 复仇 😈
- 船只受伤时触发
- 基础范围100像素，每级增加50%
- 固定造成2点伤害
- 可以击杀范围内的敌人

## 功能对比

| 功能 | 修改前 | 修改后 |
|------|--------|--------|
| 技能总数 | 33个 | 37个 |
| Epic技能数 | 5个 | 9个 |
| 自动攻击 | 无 | 激光炮 |
| 击杀效果 | 吸血、经验球 | 吸血、经验球、黑洞 |
| 受伤效果 | 减伤 | 减伤、无敌、反伤 |

## 回退方案

如需回退，恢复以下文件到修改前状态：
1. `server/games/gunbean/GunBeanSkillData.js` - 删除4个新增技能配置
2. `server/games/gunbean/GunBeanHandler.js` - 恢复原有逻辑
3. `shared/Events.js` - 删除新增事件
4. `doc/game/qiangdouren/Roguelike.md` - 恢复原有内容

## 测试建议

1. 启动游戏，升级时检查是否能看到4个新技能
2. 选择激光炮技能，等待冷却后验证是否自动发射激光
3. 选择黑洞技能，击杀敌人验证是否生成黑洞并吸引敌人
4. 选择幽灵船技能，被敌人碰撞后验证是否触发无敌
5. 选择复仇技能，被敌人碰撞后验证是否对周围敌人造成伤害

## 当前技能统计

| 稀有度 | 数量 | 技能列表 |
|--------|------|----------|
| Common | 13 | 弹跳、穿透、修复、加速、强化、快装、扩容、射程、磁铁、经验加成、子弹加速、减伤、再生 |
| Rare | 15 | 护盾、双发、吸血、暴击、散射、追踪、冰冻、毒素、幸运、火焰弹、护盾冲撞、连击、分裂弹、回旋镖、弹幕 |
| Epic | 9 | 闪电链、爆炸、多重射击、时间减缓、电磁脉冲、激光炮、黑洞、幽灵船、复仇 |
| **总计** | **37** | |
